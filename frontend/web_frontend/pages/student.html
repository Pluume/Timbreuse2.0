<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<head>
  <!-- Bootstrap Core CSS -->
  <link href="../vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

  <!-- MetisMenu CSS -->
  <link href="../vendor/metisMenu/metisMenu.min.css" rel="stylesheet">

  <!-- Custom CSS -->
  <link href="../dist/css/sb-admin-2.css" rel="stylesheet">
  <link href="../dist/css/style.css" rel="stylesheet">
  <link href="../dist/css/bootstrap-table.css" rel="stylesheet">

  <!-- Morris Charts CSS -->
  <link href="../vendor/morrisjs/morris.css" rel="stylesheet">

  <!-- Custom Fonts -->
  <link href="../vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
  <link href="../vendor/fullcalendar/css/fullcalendar.min.css" rel="stylesheet" type="text/css" />
  <title>Timbreuse - Prof panel</title>
  <script src="../dist/js/pages.js"></script>
</head>

<body>
  <div class="container" id="pageContainer" style="width: 100%;height:100px;margin: 0;margin-right: 10px;">
    <table id="stdTable" data-unique-id="id" style="width: 100%;height:100%;" data-toggle="table" data-height="800" data-click-to-select="false" data-sort-name="lname" data-pagination="false" data-sort-order="desc">
      <thead>
        <tr>
          <th data-field="state" data-checkbox="true"></th>
          <th data-field="id" style="text-align: center; vertical-align: middle; width: 36px; " data-visible="false" data-sortable="true">Student ID</th>
          <th data-field="lname" style="text-align: center; vertical-align: middle; width: 36px; " data-sortable="true">Last name</th>
          <th data-field="fname" style="text-align: center; vertical-align: middle; width: 36px; " data-sortable="true">First name</th>
          <th data-field="username" style="text-align: center; vertical-align: middle; width: 36px; " data-sortable="true">username</th>
          <th data-field="timeDiffToday" style="text-align: center; vertical-align: middle; width: 36px; " data-formatter="timeListFormatter" data-sortable="true">Time done today</th>
          <th data-field="timeDiff" style="text-align: center; vertical-align: middle; width: 36px; " data-formatter="timeListFormatter" data-sortable="true">Time delta</th>
          <th data-field="status" style="text-align: center; vertical-align: middle; width: 36px; " data-formatter="statusFormatter" data-sortable="true">Status</th>
          <th data-field="lastTagTime" style="text-align: center; vertical-align: middle; width: 36px; " data-formatter="timeFormatter" data-sortable="true">Last tag time</th>
          <th data-field="actions" style="display: inline-block" data-sortable="false" data-formatter="studentsListFormatter"><span data-toggle='modal' data-target="#addStudentModal"><button data-toggle="tooltip" data-placement='right' title='Add' href='#' onclick="emptyInput(['cfname', 'clname', 'cusername', 'ctag','cemail','cdob','cproject']);" class='btn btn-success btn-circle'><i class='fa fa-plus'></i></button></span></th>
        </tr>
      </thead>
    </table>
  </div>

  <!-- jQuery -->
  <script>
    window.$ = window.jQuery = require('../vendor/jquery/jquery.min.js');
    window.secToHMS = require('../../../utils/math.js').secondsToHms;
    window.ERROR = require('../../../request.js').ERROR;
    window.PAGES = require('../../../request.js').PAGES;
    window.SCOPE = require('../../../request.js').SCOPE;
    window.RANK = require('../../../db/db.js').RANK;
    window.STATUS = require('../../../db/db.js').STATUS;
    window.LOGS = require('../../../db/db.js').LOGS;
    setPage(window.PAGES.PROFS);
    var stdToApply = [];

    function editCb(std) {
      document.getElementById("elname").setAttribute("placeholder", std.students.user.lname == null ? "" : std.students.user.lname);
      document.getElementById("efname").setAttribute("placeholder", std.students.user.fname == null ? "" : std.students.user.fname);
      document.getElementById("eusername").setAttribute("placeholder", std.students.user.username == null ? "" : std.students.user.username);
      document.getElementById("eproject").setAttribute("placeholder", std.students.project == null ? "" : std.students.project);
      document.getElementById("edob").setAttribute("placeholder", std.students.user.dob == null ? "" : std.students.user.dob);
      document.getElementById("eemail").setAttribute("placeholder", std.students.user.email == null ? "" : std.students.user.email);
      document.getElementById("etag").setAttribute("placeholder", std.students.user.tag == null ? "" : std.students.user.tag);
      document.getElementById("editStudentID").setAttribute("value", std.students.id);
      $('#editStudentModal').modal('show');
    }

    function studentsListFormatter(val, row) {
      return "<span data-toggle='modal' data-target='#detailsStudentModal'><button data-toggle='tooltip' data-placement='left' title='Details' href='#' onclick='showDetailsModal(" + row.id +
        ",\"" + row.fname + "\",\"" + row.lname +
        "\");' class='btn btn-info btn-circle'><i class='glyphicon glyphicon-zoom-in'></i></button></span><span data-toggle='modal' data-target='#editStudentModal'><button data-toggle='tooltip' data-placement='top' title='Edit' href='#' onclick='getStudent(" +
        row.id +
        ",editCb);' class='btn btn-warning btn-circle'><i class='fa fa-edit'></i></button></span><span data-toggle='modal' data-target='#editStudentTimeModal'><button data-toggle='tooltip' data-placement='bottom' title='Edit time' href='#' onclick='stdToApply = [" +
        row.id +
        "];' class='btn btn-warning btn-circle'><i class='glyphicon glyphicon-time'></i></button></span><span data-toggle='modal' data-target='#advancedOptionsModal'><button data-toggle='tooltip' data-placement='bottom' title='Avanced Options' href='#' onclick='stdToApply = [" +
        row.id +
        "];' class='btn btn-secondary btn-circle'><i class='fa fa-check'></i></button></span><span data-toggle='modal' data-target='#delStudentModal'><button data-toggle='tooltip' data-placement='bottom' title='Delete' href='#' onclick='stdToApply = [" +
        row.id +
        "];' class='btn btn-danger btn-circle'><i class='fa fa-bomb'></i></button></span>";
    }

    function timeListFormatter(val) {
      return window.secToHMS(parseInt(val, 10));
    }

    function timeFormatter(val) {
      return require("electron").remote.require("moment")(val).format("DD MMMM YYYY <br /> H:mm:ss");
    }

    function statusFormatter(val, row) {
      var status = document.createElement("div");
      switch (val) {
        case window.STATUS.IN:
          status.setAttribute("class", "bg-success");
          status.innerHTML = "IN";
          break;
        case window.STATUS.OUT:
          status.setAttribute("class", "bg-danger");
          status.innerHTML = "OUT";
          break;
        case window.STATUS.ABS:
          status.setAttribute("class", "bg-info");
          status.innerHTML = "ABSENT";
          break;

        default:
          status.setAttribute("class", "bg-warning");
          status.innerHTML = "NONE";
      }
      return status.outerHTML;
    }
    $(document).ready(function() {
      $("body").tooltip({
        selector: '[data-toggle=tooltip]'
      });
      getStudents("stdTable", () => {
        getClass((tclass) => {
          if (tclass == null || tclass == undefined) {
            document.getElementById("ctclass").setAttribute("placeholder", "error");
            document.getElementById("etclass").setAttribute("placeholder", "error");
          } else {
            document.getElementById("ctclass").setAttribute("placeholder", tclass.name);
            document.getElementById("etclass").setAttribute("placeholder", tclass.name);
            window.currentClass = tclass;
          }

        });
      });
      $("#detailsStudentModal").on('shown.bs.modal', function() {
        var viewportHeight = $(window).height();
        var modalDialogHeight = $(this).find('.modal-dialog').innerHeight();
        var modalHeaderHeight = $(this).find('.modal-header').outerHeight();
        var modalBodyHeight = $(this).find('.modal-body').innerHeight();
        var modalFooterHeight = $(this).find('.modal-footer').outerHeight();
        $('#detailsCalendar').fullCalendar('option', 'height', viewportHeight - modalHeaderHeight - modalFooterHeight - modalBodyHeight);
      });
      activateValidator();

    });

    function submitCreateModal() {
        createStudent(document.getElementById('cfname').value, document.getElementById('clname').value, document.getElementById('cusername').value, document.getElementById('cemail').value, document.getElementById('ctag').value, document.getElementById(
          'ctclass').value, document.getElementById('cdob').value, document.getElementById('cproject').value, "stdTable");
        $('#addStudentModal').modal('toggle');
    }

    function submitDeleteModal() {
      deleteStudent(stdToApply, "stdTable");
      $('#delStudentModal').modal('toggle');
    }

    function showDetailsModal(id, fname, lname) {
      document.getElementById("detailsStudentModalTitle").innerHTML = "Detail of " + fname + " " + lname;
      getLogs(id, (data) => {
        var moment = require("electron").remote.require("moment");
        var toDelete = [];

        for (var i = 0; i < data.format.length; i++) {
          if (!moment(data.format[i].start).isValid()) {
            data.format.splice(i, 1);
            i = i - 1;
          }
        }

        $('#detailsCalendar').fullCalendar({
          header: {
            left: 'prev,next today',
            center: 'title',
            right: 'month,listWeek'
          },
          navLinks: true, // can click day/week names to navigate views
          editable: false,
          defaultDate: "2017-05-08",
          defaultView: 'listWeek',
          weekNumbers: true,
          eventLimit: true, // allow "more" link when too many events
          events: data.format,
          timeFormat: 'H:mm',
          firstDay: 1,
          weekNumbersWithinDays: true
        });
        $('#calendar').fullCalendar('render');
        $('#calendar').fullCalendar({
          dayClick: function(date, jsEvent, view) {
            $('#calendar').fullCalendar('gotoDate', date);
            $('#calendar').fullCalendar('changeView', 'list');
          }
        });
      });
    }

    function closeDetailsModal() {
      $('#detailsCalendar').fullCalendar("destroy");
    }

    function submitEditModal(id) {
      editStudent(id, document.getElementById('efname').value, document.getElementById('elname').value, document.getElementById('eusername').value, document.getElementById('eemail').value, document.getElementById('etag').value, document.getElementById(
        'edob').value, document.getElementById('eproject').value, document.getElementById('epass').checked, "stdTable");
      $('#editStudentModal').modal('hide');
      emptyInput(["efname", "elname", "eusername", "etag", "eemail", "edob", "eproject"]);
      document.getElementById("epass").checked = false;
    }

    function submitAdvancedOptionsModal(id) {
      if (document.getElementById("setabsent_radio").checked) {
        setAbsent(stdToApply, document.getElementById("advancedoptions_comment").value);
      } else if (document.getElementById("setfixed_radio").checked) {
        setFixed(stdToApply, document.getElementById("advancedoptions_comment").value);
      } else if (document.getElementById("tag_radio").checked) {
        if (stdToApply.length != 1) {
          redAlert("Can't tag multiple students at once");
          return;
        }
        tag(stdToApply[0], document.getElementById("advancedoptions_comment").value);
      }
      document.getElementById("advancedoptions_comment").value = "";
      $('#advancedOptionsModal').modal('hide');
    }
  </script>
  <div class="modal fade" id="addStudentModal" tabindex="-1" role="dialog" aria-labelledby="addStudentModal" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form id="addStudentForm">
          <div class="modal-header">
            <h2 class="modal-title" id="addStudentModalTitle">Create a new student</h2>
          </div>
          <div class="modal-body">

            <div id="fgctclass" class="form-group">
              <label for="ctclass" class="form-control-label">Class : </label>
              <input type="text" class="form-control" readonly id="ctclass">
            </div>
            <div id="fgcfname" class="form-group">
              <label for="cfname" class="form-control-label">First name :</label>
              <input type="text" class="form-control" name="cfname" id="cfname">
              <span class="help-block" id="error"></span>
            </div>
            <div id="fgclname" class="form-group">
              <label for="clname" class="form-control-label">Last name:</label>
              <input type="text" class="form-control" name="clname" id="clname">
              <span class="help-block" id="error"></span>
            </div>
            <div id="fgcusername" class="form-group">
              <label for="cusername" class="form-control-label">Username :</label>
              <input type="text" class="form-control" name="cusername" id="cusername">
              <span class="help-block" id="error"></span>
            </div>
            <div id="fgcdob" class="form-group">
              <label for="cdob" class="form-control-label">Date of birth:</label>
              <input type="text" class="form-control" name="cdob" id="cdob">
              <span class="help-block" id="error"></span>
            </div>
            <div id="fgcemail" class="form-group">
              <label for="cemail" class="form-control-label">Email :</label>
              <input type="text" class="form-control" name="cemail" id="cemail">
              <span class="help-block" id="error"></span>
            </div>
            <div id="fgctag" class="form-group">
              <label for="ctag" class="form-control-label">Tag :</label>
              <input type="text" class="form-control" name="ctag" id="ctag">
              <span class="help-block" id="error"></span>
            </div>
            <div id="fgcproject" class="form-group">
              <label for="cproject" class="form-control-label">Project :</label>
              <input type="text" class="form-control" id="cproject">
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="cancelForm('#addStudentForm');" data-dismiss="modal">Close</button>
            <button type="submit" class="btn btn-success">Create</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="modal fade" id="editStudentTimeModal" tabindex="-1" role="dialog" aria-labelledby="editStudentTimeModal" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="editStudentTimeModalTitle">Edit student's time</h2>
        </div>
        <div class="modal-body">
          <form>
            <div class="radio">
              <label for="settime_group"><input id="settime_radio" group="editTime" checked type="radio" name="optradio">Set time</label>
              <div id="settime_group">
                <div display="inline-block">
                  <label for="settime_hours">Hours</label>
                  <input id="settime_hours" class="form-control" group="editTime" type="number" value="0">
                </div>
                <div display="inline-block">
                  <label for="settime_minutes">Minutes</label>
                  <input id="settime_minutes" class="form-control" group="editTime" type="number" value="0">
                </div>
              </div>
            </div>
            <div class="radio">
              <label for="modtime_group"><input id="modtime_radio" group="editTime" type="radio" name="optradio">Add/Substract time</label>
              <div id="modtime_group">
                <div display="inline-block">
                  <label for="edittime_hours">Hours</label>
                  <input id="edittime_hours" class="form-control" disabled="true" group="editTime" type="number" value="0">
                </div>
                <div display="inline-block">
                  <label for="edittime_minutes">Minutes</label>
                  <input id="edittime_minutes" class="form-control" disabled="true" group="editTime" type="number" value="0">
                </div>
              </div>
            </div>
            <div class="radio">
              <label for="resettime_group"><input id="resettime_radio" group="editTime" type="radio" name="optradio">Reset</label>
            </div>
            <br />
            <label for="edittime_comment">Comments</label>
            <input id="edittime_comment" class="form-control" type="text" value="">
            <script>
              $('input[type=radio][group=editTime]').on('change', function() {
                switch ($(this).attr("id")) {
                  case 'resettime_radio':
                    $('#settime_hours').prop("disabled", true);
                    $('#settime_minutes').prop("disabled", true);
                    $('#edittime_hours').prop("disabled", true);
                    $('#edittime_minutes').prop("disabled", true);
                    break;
                  case 'modtime_radio':
                    $('#settime_hours').prop("disabled", true);
                    $('#settime_minutes').prop("disabled", true);
                    $('#edittime_hours').prop("disabled", false);
                    $('#edittime_minutes').prop("disabled", false);
                    break;
                  case 'settime_radio':
                    $('#settime_hours').prop("disabled", false);
                    $('#settime_minutes').prop("disabled", false);
                    $('#edittime_hours').prop("disabled", true);
                    $('#edittime_minutes').prop("disabled", true);
                    break;
                }
              });

              function preSubmitEditTimeModal() {
                $('#editStudentTimeModal').modal('toggle');
                if (document.getElementById("resettime_radio").checked) {
                  resetTime(stdToApply);
                  return;
                } else if (document.getElementById("modtime_radio").checked) {
                  var time = parseInt(document.getElementById("edittime_hours").value, 10) * 3600 + parseInt(document.getElementById("edittime_minutes").value, 10) * 60;
                  if (isNaN(time))
                    time = 0;
                  modTime(stdToApply, time, "Comments not included for now");
                  return;
                } else if (document.getElementById("settime_radio").checked) {
                  var time = parseInt(document.getElementById("settime_hours").value, 10) * 3600 + parseInt(document.getElementById("settime_minutes").value, 10) * 60;
                  if (isNaN(time))
                    time = 0;
                  setTime(stdToApply, time)
                  return;
                }
              }
            </script>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" onclick="preSubmitEditTimeModal();" class="btn btn-success">Apply</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="advancedOptionsModal" tabindex="-1" role="dialog" aria-labelledby="advancedOptionsModal" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="eadvancedOptionsModalTitle">Advanced options :</h2>
        </div>
        <div class="modal-body">
          <form>
            <div class="radio">
              <label for="setabsent_radio"><input id="setabsent_radio" group="advancedoptions" name="advancedoptions" checked type="radio">Set absent</label>
            </div>
            <div class="radio">
              <label for="setfixed_radio"><input id="setfixed_radio" group="advancedoptions" name="advancedoptions" type="radio">Toggle fixed</label>
            </div>
            <div class="radio">
              <label for="tag_radio"><input id="tag_radio" group="advancedoptions" name="advancedoptions" type="radio">Tag</label>
            </div>
            <br />
            <label for="advancedoptions_comment">Comments</label>
            <input id="advancedoptions_comment" class="form-control" type="text" value="">
            <script>
              $('input[type=radio][group=advancedoptions]').on('change', function() {
                switch ($(this).attr("id")) {

                }
              });
            </script>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" onclick="submitAdvancedOptionsModal();" class="btn btn-success">Apply</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="delStudentModal" tabindex="-1" role="dialog" aria-labelledby="delStudentModal" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="delStudentModalTitle">Are you sure to delete this/these student(s) ?</h2>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          <button type="button" onclick="submitDeleteModal();" class="btn btn-danger">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    .modal-dialogMax {
      width: 98%;
      height: 98%;
      padding: 0;
      margin: 1%;
    }

    .modal-contentMax {
      height: 100%;
      border-radius: 0;
    }
  </style>
  <div class="modal fade" id="detailsStudentModal" tabindex="-1" role="dialog" aria-labelledby="detailsStudentModal" aria-hidden="true">
    <div class="modal-dialog modal-dialogMax" role="document">
      <div class="modal-content modal-contentMax">
        <div class="modal-header">
          <h2 class="modal-title" id="detailsStudentModalTitle"></h2>
        </div>
        <div class="modal-body">
          <div id="detailsCalendar"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="closeDetailsModal();" data-dismiss="modal">Ok</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="editStudentModal" tabindex="-1" role="dialog" aria-labelledby="editStudentModal" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form id="editStudentForm">
        <div class="modal-header">
          <h2 class="modal-title" id="editStudentModalTitle">Edit this student</h2>
        </div>
        <div class="modal-body">

            <div id="fgetclass" class="form-group">
              <label for="etclass" class="form-control-label">Class : </label>
              <input type="text" class="form-control" readonly id="etclass">
            </div>
            <div id="fgecfname" class="form-group">
              <label for="efname" class="form-control-label">First name :</label>
              <input type="text" class="form-control" name="efname" id="efname">
              <span class="help-block" id="error"></span>
            </div>
            <div id="fgelname" class="form-group">
              <label for="elname" class="form-control-label">Last name:</label>
              <input type="text" class="form-control" name="elname" id="elname">
              <span class="help-block" id="error"></span>
            </div>
            <div id="fgeusername" class="form-group">
              <label for="eusername" class="form-control-label">Username :</label>
              <input type="text" class="form-control" name="eusername" id="eusername">
              <span class="help-block" id="error"></span>
            </div>
            <div id="fgedob" class="form-group">
              <label for="edob" class="form-control-label">Date of birth:</label>
              <input type="text" class="form-control" name="edob" id="edob">
              <span class="help-block" id="error"></span>
            </div>
            <div id="fgeemail" class="form-group">
              <label for="eemail" class="form-control-label">Email :</label>
              <input type="text" class="form-control" name="eemail" id="eemail">
              <span class="help-block" id="error"></span>
            </div>


            <div id="fgetag" class="form-group">
              <label for="etag" class="form-control-label">Tag :</label>
              <input type="text" class="form-control" name="etag" id="etag">
              <span class="help-block" id="error"></span>
            </div>
            <div id="fgeproject" class="form-group">
              <label for="eproject" class="form-control-label">Project :</label>
              <input type="text" class="form-control" id="eproject">
              <span class="help-block" id="error"></span>
            </div>
            <div id="fgepass" class="form-group">
              <div class="checkbox">
                <label>
                                  <input id="epass" type="checkbox" value="Reset password">Reset password
                              </label>
              </div>
            </div>

        </div>
        <div class="modal-footer">
          <input type="hidden" id="editStudentID" value=""/>
          <button type="button" class="btn btn-secondary" onclick="cancelForm('#editStudentForm');"data-dismiss="modal">Close</button>
          <button type="submit" id="updateSubmit" class="btn btn-primary">Update</button>
        </div>
        </form>
      </div>
    </div>
  </div>
  <script>
  </script>
  <!-- Bootstrap Core JavaScript -->
  <script src="../vendor/bootstrap/js/bootstrap.min.js"></script>

  <!-- Metis Menu Plugin JavaScript -->
  <script src="../vendor/metisMenu/metisMenu.min.js"></script>

  <!-- Morris Charts JavaScript -->
  <script src="../vendor/raphael/raphael.min.js"></script>
  <script src="../vendor/morrisjs/morris.min.js"></script>
  <script src="../data/morris-data.js"></script>

  <!-- Custom Theme JavaScript -->
  <script src="../dist/js/sb-admin-2.js"></script>
  <script src="../dist/js/bootstrap-table.js"></script>
  <script src="../dist/js/informations.js"></script>
  <script src="../dist/js/redirect.js"></script>
  <script src="../dist/js/utils.js"></script>
  <script src="../vendor/moment/moment.js"></script>
  <script src="../vendor/fullcalendar/js/fullcalendar.min.js"></script>
  <script src="../vendor/validator/jquery.validate.min.js"></script>
  <script src="../dist/js/validate.js"></script>
</body>

</html>
